# ブラウザにやさしいHTML/CSS

## 三原則

- 少なくする
- 軽くする
- 近くする

## 基本的なテクニック集

- CSSスプライト&ファイル結合
- minify
- 画像圧縮
- テキスト圧縮
- キャッシュ利用

## HTMLダウンロードの流れ

### HTTPリクエスト①

- サーバにHTMLのみリクエストする。

### DNS解決①

- ドメインのIPアドレスを調べる。

### TCP接続①

- IPが判明したら目的のサーバに接続する。

### HTTPリクエスト②

- HTMLをダウンロードしたらブラウザでパース(文法・構文の解析)する。
- パースされた結果に基づき、css/js/画像ファイルをリクエストする。
- リクエストは記述の上から順番に行われる。

### DNS解決②

- ドメインごとに名前解決が行われる。

### TCP接続②

- すべてのリクエスト接続時に行われる。ここが意外と時間がかかるポイント…
- ダウンロードはファイル6本ずつ並列で行われる。ただしIE6/7は2本ずつ。

## パース

- 読み込んだHTMLが解析され、DOM Treeが構築される。
- 読み込んだCSSが解析され、CSSOM(CSS Object Model)が構築される。
- DOM TreeとCSSOMからRender Treeが構築される。

## DOM TreeとRender Treeの違い

|DOM Tree|Render Tree|
|---|---|
|HTMLの階層構造|実際にレンダリングするときの構造|
|すべてのDOMが格納されている|表示する要素のみ格納されている|

## Render Tree

- headタグ, display: none; の要素は含まれない。
- visibility: hidden; の要素は含まれる。
- absolute/fixed の要素は別コンテキストになる。

## Render Layer

- absolute/fixed は他の要素との相対座標計算がないため、高速。
- transform は left等よりも高速。

## JavaScriptの実行

- パーサーが`<script>`タグに到達した時点で解析・実行される。
- `<body>`タグ内で読み込まれる場合、リソースを取得するまでレンダリングが中止される。

## 高速化するために

### DNSプリフェッチ

- 外部ドメインの名前解決を事前に矯正できる。
- ユーザがアクセスする前に名前解決が完了している。

### 画像のサイズ/量を減らす

- まずはCSSスプライトを徹底する。
- PCでは300KB、MBでは30KBを上限に用意する。

### リソースの読み込み順を間違えない

- CSS→JSの順番に。
- JSは`</body>`直前に読み込むのが理想。

### CSSのエフェクトはほどほどに

- opacity/gradient/box-shadow/text-shadow は使いすぎると重くなる。

### アニメーションはほどほどに

- JSよりもCSSの方が高速。
- モバイルでも滑らかに表現するためには、ハードウェアアクセラレーション(transform3d など)を利用する。

### SVGの適切な利用

- Retina対応などで倍化した画像を多用すると、パフォーマンス劣化につながる。
- 4K解像度やそれ以上のものに対応するためには、ベクターグラフィックが最適。
- フォールバックとして非対応ブラウザにPNGを用意する。

## その他の対策

### Webフォント

- IEでジャギったり、Androidで表示されない場合もあるので、対象ブラウザでのテストを確実に行う。
- プログレッシブレンダリングではないため、体感速度では遅く感じる可能性もある。

## 参考URL

- [ブラウザにやさしいHTML/CSS](http://www.slideshare.net/TakeharuIgari/htmlcss-34506501)
- [ブラウザレンダリングの仕組みを理解して、ブラウザに優しいJavaScriptを書こう](http://www.yoheim.net/blog.php?q=20140703)
- [いまさら聞けない「Webブラウザ」超入門](http://www.atmarkit.co.jp/ait/articles/0804/14/news107_3.html)
- [DNSプリフェッチでウェブページの読み込み速度をスピードアップ](https://www.suzukikenichi.com/blog/dns-prefetching/)
