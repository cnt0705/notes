# キャッシュの基礎知識

フランス語の cacher が語源で「隠し場所」という意味がある。  
コンピュータシステムの文脈でいうと、

> ある領域から他の領域へ情報を転送する際、その転送遅延を極力隠蔽し転送効率を向上するために考案された記憶階層の実現手段である。
（略）
転送元と転送先の中間に位置し、データ内容の一部とその参照を保持する。データ転送元への転送要求があり、それへの参照が既にキャッシュに格納されていた場合は、元データからの転送は行わずキャッシュが転送を代行する。

[Wikipedia - キャッシュ (コンピュータシステム)](https://ja.wikipedia.org/wiki/%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5_(%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0))

一度実行したプログラムの計算結果をキャッシュとして保存しておけば、本来はリクエストのたびに行われる計算を省くことができ、**データ転送の高速化** が実現できる。  
OS や CDN, DNS などのネットワーキングレイヤー、Web アプリケーション、データベースといった、さまざまなレイヤーに応用できる。

## ブラウザキャッシュ

アクセスした Web ページの HTML, CSS, JavaScript, 画像などのデータをローカル PC 内に保存する。

### Cache-Control ヘッダ

Cache-Control ヘッダを HTTP レスポンスに記述する。  
Web アプリケーションからブラウザに送るコンテンツのキャッシュコントロール方法について、プロキシサーバやキャッシュサーバに指示することができる。

|ディレクティブ|内容|
|:--|:--|
|public|レスポンスをキャッシュし、複数ユーザで共有できるようにする|
|private|レスポンスをキャッシュし、特定ユーザのみが使えるようにする|
|no-store|レスポンスをキャッシュさせない|
|no-cache|キャッシュを再利用する前に、キャッシュがその時点で有効かどうかを Web サーバに問い合わせる|
|must-revalidate|キャッシュを再利用する前に、キャッシュがその時点で有効かどうかを Web サーバに問い合わせる|
|max-age|コンテンツの有効期限を指定する|

cf. [no-cache と must-revalidate の違い](https://qiita.com/shibukawa/items/85fca33a96704737c075#%E5%89%8D%E5%9B%9E%E3%81%8B%E3%82%89%E3%81%AE%E6%9B%B4%E6%96%B0)  
cf. [CDN切り替え作業における、Web版メルカリの個人情報流出の原因につきまして](http://tech.mercari.com/entry/2017/06/22/204500)

## プロキシキャッシュ

プロキシサーバ：クライアントと Web サーバ間のデータ転送を中継するサーバのこと。  
以前にアクセスした Web ページの情報をプロキシサーバの HDD などに一時的にキャッシュすることで、キャッシュサーバとして機能させることができる。  
プロキシサーバは、プロキシの全利用者のキャッシュを保持できる。  
誰かがアクセスした Web ページのコンテンツをプロキシサーバにキャッシュしておけば、2 人目以降が同じページを見る際にはキャッシュから応答するので、通信を効率化できる。

cf. [リバースプロキシとフォワードプロキシの違い](http://wa3.i-3-i.info/word1755.html)

### CDN (Content Delivery Network)

インターネット上にキャッシュサーバを分散配置する。  
エンドユーザに最も近い経路にあるキャッシュサーバ（リバースプロキシ）からオリジナルの Web サーバに代わって Web コンテンツを配信する仕組みのこと。

## クエリキャッシュ

DB を参照した結果を MySQL 内のメモリにキャッシュし、次に同一の参照が行われた場合に、キャッシュした結果を返却する機能のこと。  
ただし、クエリはバイト単位で一致している必要がある。  
クエリ結果がキャッシュから返された数をヒット数といい、ヒット率が低い場合にはキャッシュをオフにしたほうが逆にパフォーマンスが上がるとか…

### memcached (Memory Cache Daemon)

分散メモリキャッシュサーバのこと。  
DB への問い合わせ結果を一時的にキャッシュすることで、アクセス回数を減らすことができる。  
メモリ上にデータを格納するので、データを高速に読み書きできる。

cf. [MySQL自体のクエリキャッシュとの違い](http://tech.feedforce.jp/memcached.html)

## 参考記事

- [AWS - キャッシュの概要](https://aws.amazon.com/jp/caching/)
- [HTTP キャッシュ](https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching?hl=ja)
- [キャッシュについて整理](https://qiita.com/anchoor/items/2dc6ab8347c940ea4648)
- [セキュリティ対策としての Cache-Control ヘッダについて](https://kiririmode.hatenablog.jp/entry/20170625/1498389317)
- [IPA - プロキシキャッシュ対策](https://www.ipa.go.jp/security/awareness/vendor/programmingv2/contents/405.html)
- [CDNの仕組み](https://blog.redbox.ne.jp/what-is-cdn.html)
- [Webサイト運用を楽にしてくれるCDN](https://qiita.com/fuji8ra/items/3b3bffe3869cb165cfbf)
